#include "CppUTest/TestHarness.h"
#include "water.h"

#define WATER_PIN 3

TEST_GROUP(relay)
{
  void setup()
  {
    relay_init(&water_port, WATER_PIN);
  }
  
  void teardown()
  {
  }

  uint8_t water_port;
  
};

TEST(relay, RelayStartStop)
{
  relay_on();
  BYTES_EQUAL(RELAY_ON, relay_get_status());
  relay_off();
  BYTES_EQUAL(RELAY_OFF, relay_get_status());
}

TEST(relay, RelayMemory)
{
  relay_port = 0;
  BYTES_EQUAL(RELAY_OFF, relay_get_status());
  relay_port = (1<<RELAY_PIN);
  BYTES_EQUAL(RELAY_ON, relay_get_status());
}

TEST(relay, RelayMemory2)
{
  relay_on();
  CHECK_TRUE(relay_port & (1<<RELAY_PIN));
  relay_off();
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
}

TEST(relay, CooldownTest)
{
  relay_set_cooldown(100);
  relay_on();
  BYTES_EQUAL(RELAY_ON, relay_get_status());
  relay_off();
  relay_on();
  BYTES_EQUAL(RELAY_ERROR_COOLDOWN, relay_get_status());
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
}

TEST(relay, ManyStartsCooldown)
{
  relay_set_cooldown(100);
  relay_on();
  relay_on();
  relay_on();
  BYTES_EQUAL(RELAY_ON, relay_get_status());
}

TEST(relay,StartOnError)
{
  relay_set_cooldown(10);
  relay_on();
  BYTES_EQUAL(RELAY_ON, relay_get_status());
  relay_off();
  relay_on();
  BYTES_EQUAL(RELAY_ERROR_COOLDOWN, relay_get_status());
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
  for (int i=0; i<15;i++)
    {
      relay_timer_inc();
    }
  relay_on();
  BYTES_EQUAL(RELAY_ERROR_COOLDOWN, relay_get_status());
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
    
}

TEST(relay, MaximumOnTime)
{
  relay_set_maxon(10);

  relay_on();
  
  for (int i=0; i<9;i++)
    {
      relay_timer_inc();
    }
  BYTES_EQUAL(RELAY_ON, relay_get_status());
  relay_timer_inc();
  BYTES_EQUAL(RELAY_ERROR_MAXON, relay_get_status());
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
}

TEST(relay, MaxOnOneCount)
{
  relay_set_maxon(1);

  relay_on();
  
  BYTES_EQUAL(RELAY_ON, relay_get_status());
  relay_timer_inc();
  BYTES_EQUAL(RELAY_ERROR_MAXON, relay_get_status());
  CHECK_FALSE(relay_port & (1<<RELAY_PIN));
}


TEST(relay, getCooldown)
{
  relay_set_cooldown(21312);
  LONGS_EQUAL(21312,relay_get_cooldown());
  relay_set_cooldown(0xFFFFFFFF);
  LONGS_EQUAL(0xFFFFFFFF,relay_get_cooldown());
}

TEST(relay, getMaxon)
{
  relay_set_maxon(321312);
  LONGS_EQUAL(321312,relay_get_maxon());
  relay_set_maxon(0xFFFFFFFF);
  LONGS_EQUAL(0xFFFFFFFF,relay_get_maxon());
}

TEST(relay, getTimer)
{
  relay_on();
  LONGS_EQUAL(0,relay_get_timer());

  for (int i=0; i<2050000; i++)
    {
      relay_timer_inc();
    }
  LONGS_EQUAL(2050000,relay_get_timer());

}
